<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TStaff Task Poster Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'IBM Plex Sans Thai', sans-serif;
      background: #f6f7fb;
      text-align: center;
      padding: 16px;
    }
    #poster {
      width: 100%;
      max-width: 900px;
      height: auto;
      border: 2px solid #ddd;
      background:#fff;
      margin-top: 20px;
    }
    input, select, textarea, button {
      padding: 10px;
      font-size: 18px;
      margin: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
    }
    textarea {
      width: 90%;
      height: 100px;
      resize: none;
    }
    button {
      background: #AD28F5;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { opacity: .9; }
  </style>
</head>

<body>
  <h2>üìå TStaff Task Poster Generator</h2>

  <select id="taskSelect" style="min-width:300px;"></select><br>
  <input type="text" id="line1" placeholder="Bottom Line 1 (eg. Worth 2 pts)">
  <input type="text" id="line2" placeholder="Bottom Line 2">
  <textarea id="descInput" placeholder="Description (optional)"></textarea>
  <br>

  <button onclick="drawPoster()">‚úÖ Generate Poster</button>
  <button onclick="downloadPoster()">‚¨áÔ∏è Download Poster</button>

  <canvas id="poster" width="1920" height="1440"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDKHyMNxgnUH9zn0HQHDNf98GFphC9rv_4",
  authDomain:"tstaff-tcf.firebaseapp.com",
  projectId:"tstaff-tcf",
  storageBucket:"tstaff-tcf.firebasestorage.app",
  messagingSenderId:"1038965947691",
  appId:"1:1038965947691:web:8a2f21a6424b82c14ad96e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const DUE_LABELS = {10:"October",111:"Early November",112:"Late November",121:"Early December",122:"Late December",1:"January"};
const PRIORITY_LABELS = {1:"High",2:"Medium",3:"Low"};
const PRIO_COLORS = {1:"#ef4444",2:"#fb923c",3:"#eab308"};
const STATUS_LABELS = {red:"Not Done",yellow:"In Progress",green:"Done"};

const DEPT_LABELS = {
  core:"Core Team", finance:"Finance & Sponsors", pr:"Public Relations",
  supervision:"Student Supervision", activities:"Activities",
  recruits:"New Recruits", cc:"Creative Contest", allmembers:"All Members"
};
const DEPT_COLORS = {
  core:["#2D68F2","#fff"], finance:["#26a269","#fff"],
  pr:["#7c3aed","#fff"], supervision:["#eab308","#fff"],
  activities:["#ef4444","#fff"], recruits:["#fb923c","#fff"],
  cc:["#9c6b3c","#fff"], allmembers:["#64748b","#fff"]
};

CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  this.beginPath();
  this.moveTo(x+r,y);
  this.lineTo(x+w-r,y);
  this.quadraticCurveTo(x+w,y,x+w,y+r);
  this.lineTo(x+w,y+h-r);
  this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  this.lineTo(x+r,y+h);
  this.quadraticCurveTo(x,y+h,x,y+h-r);
  this.lineTo(x,y+r);
  this.quadraticCurveTo(x,y,x+r,y);
  this.closePath();
};

function pill(ctx,x,y,text,bg,fg){
  ctx.font="bold 48px 'IBM Plex Sans Thai'";
  const pad=28, h=64;
  const w = ctx.measureText(text).width + pad*2;
  ctx.fillStyle=bg;
  ctx.roundRect(x,y,w,h,32);
  ctx.fill();
  ctx.fillStyle=fg;
  ctx.textBaseline="middle";
  ctx.fillText(text,x+pad,y+h/2);
  return x+w+20;
}

function wrap(ctx,text,x,y,max,line){
  const words=text.split(" ");
  let curr="";
  for(const w of words){
    const test=curr+w+" ";
    if(ctx.measureText(test).width > max){
      ctx.fillText(curr,x,y);
      y+=line;
      curr=w+" ";
    } else curr=test;
  }
  ctx.fillText(curr,x,y);
  return y;
}

async function loadTasks(){
  const sel = document.getElementById("taskSelect");
  sel.innerHTML = "<option disabled>Loading...</option>";

  const snap = await getDocs(collection(db,"taskcheck"));
  sel.innerHTML = "";

  // ‚úÖ Convert to array so we can sort
  const list = [];
  snap.forEach(doc => {
    const data = doc.data();
    list.push({ id: doc.id, name: data.name || "Unnamed Task" });
  });

  // ‚úÖ Alphabetical sorting (Thai-aware)
  list.sort((a, b) => a.name.localeCompare(b.name, 'th'));

  // ‚úÖ Populate dropdown
  list.forEach(task => {
    const o = document.createElement("option");
    o.value = task.id;
    o.textContent = task.name;
    sel.appendChild(o);
  });
}

async function drawPoster(){
  const id=document.getElementById("taskSelect").value;
  if(!id) return alert("Select a task!");

  const snap=await getDoc(doc(db,"taskcheck",id));
  if(!snap.exists()) return;
  const t=snap.data();

  const c=document.getElementById("poster");
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,c.width,c.height);

  // Banner
  const grad=ctx.createLinearGradient(0,0,c.width,0);
  grad.addColorStop(0,"#AD28F5");
  grad.addColorStop(1,"#2D68F2");
  ctx.fillStyle=grad;
  ctx.fillRect(0,0,c.width,160);
  ctx.font="bold 75px 'IBM Plex Sans Thai'";
  ctx.fillStyle="#fff";
  ctx.fillText("TStaff",80,105);

  // Pills
  let x=120,y=260;
  if(t.priority) x=pill(ctx,x,y,PRIORITY_LABELS[t.priority],PRIO_COLORS[t.priority],"#fff");
  if(t.department){
    const [bg,fg]=DEPT_COLORS[t.department] || ["#64748b","#fff"];
    x=pill(ctx,x,y,DEPT_LABELS[t.department],bg,fg);
  }
  if(t.due) x=pill(ctx,x,y,DUE_LABELS[t.due],"#4b5563","#fff");

  // Task title
  y+=40;
  ctx.fillStyle="#000";
  ctx.font="700 90px 'IBM Plex Sans Thai'";
  y=wrap(ctx, t.name, 120, y+140, c.width-240, 100)+120;

  // ‚úÖ Status
  if(t.status){
    ctx.font="600 60px 'IBM Plex Sans Thai'";
    ctx.fillStyle="#333";
    ctx.fillText(`Status: ${STATUS_LABELS[t.status] || t.status}`,120,y);
    y+=100;
  }

  // ‚úÖ Description block
  const desc=document.getElementById("descInput").value;
  if(desc.trim()){
    ctx.font="400 55px 'IBM Plex Sans Thai'";
    y=wrap(ctx, desc.trim(), 120, y, c.width-240, 80)+50;
  }

  // ‚úÖ Scoring bottom text
  const b1=document.getElementById("line1").value;
  const b2=document.getElementById("line2").value;

  ctx.font="600 60px 'IBM Plex Sans Thai'";
  if(b1) ctx.fillText(b1,120,c.height-300);
  if(b2) ctx.fillText(b2,120,c.height-200);
}

function downloadPoster(){
  const c=document.getElementById("poster");
  const link=document.createElement("a");
  link.download="tstaff-task.png";
  link.href=c.toDataURL("image/png");
  link.click();
}

window.onload=loadTasks;
window.drawPoster=drawPoster;
window.downloadPoster=downloadPoster;
</script>

</body>
</html>
