<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TStaff</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --brand-start: #AD28F5;
      --brand-end: #2D68F2;
      --bg: #f6f7fb;
      --card: #fff;
      --text: #111;
      --muted: #666;
      --border: #e6e8ef;

      --dept-all: #64748b;
      --dept-core: #2D68F2;
      --dept-finance: #26a269;
      --dept-pr: #7c3aed;
      --dept-supervision: #eab308;
      --dept-activities: #ef4444;
      --dept-recruits: #fb923c;
      --dept-cc: #9c6b3c;

      --prio-1: #ef4444;
      --prio-2: #fb923c;
      --prio-3: #eab308;

      --status-red: #ef4444;
      --status-yellow: #f5c32c;
      --status-green: #22c55e;
    }

    * {
      box-sizing: border-box;
      font-family: 'IBM Plex Sans Thai', system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      background: linear-gradient(90deg, var(--brand-start), var(--brand-end));
      color: #fff;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      font-size: 1.2rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .12);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .filters {
      display: grid;
      gap: .6rem;
      grid-template-columns: 1fr repeat(4, minmax(160px, 230px));
      padding: 10px 14px;
    }

    @media(max-width:1000px) {
      .filters {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media(max-width:640px) {
      .filters {
        grid-template-columns: 1fr;
      }
    }

    .input,
    .select,
    .btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: .65rem .8rem;
      border-radius: 10px !important;
      outline: none;
      font-size: .95rem;
    }

    .select:focus,
    .input:focus {
      border-color: var(--brand-end);
      box-shadow: 0 0 0 4px rgba(45, 104, 242, .12);
    }

    .wrap {
      padding: 4px 12px 24px;
    }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
    }

    @media(max-width:1100px) {
      .grid {
        grid-template-columns: repeat(2, minmax(250px, 1fr));
      }
    }

    @media(max-width:700px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 6px solid transparent;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .06);
      opacity: 0;
      transform: translateY(6px);
      animation: fadeUp .35s ease forwards;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 28px rgba(0, 0, 0, .1);
    }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pill {
      border-radius: 999px;
      padding: .25rem .55rem;
      font-size: .78rem;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .dept-all {
      background: #e2e8f0;
      color: #0f172a;
      border-color: #cbd5e1;
    }

    .dept-core {
      color: #fff;
      background: var(--dept-core);
      border-color: transparent;
    }

    .dept-finance {
      color: #fff;
      background: var(--dept-finance);
      border-color: transparent;
    }

    .dept-pr {
      color: #fff;
      background: var(--dept-pr);
      border-color: transparent;
    }

    .dept-supervision {
      background: var(--dept-supervision);
      color: #fff;
      border-color: transparent;
    }

    .dept-activities {
      color: #fff;
      background: var(--dept-activities);
      border-color: transparent;
    }

    .dept-recruits {
      color: #fff;
      background: var(--dept-recruits);
      border-color: transparent;
    }

    .dept-cc {
      color: #fff;
      background: var(--dept-cc);
      border-color: transparent;
    }

    .prio-1 {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .prio-2 {
      background: #ffedd5;
      color: #9a3412;
      border-color: #fed7aa;
    }

    .prio-3 {
      background: #fef3c7;
      color: #854d0e;
      border-color: #fde68a;
    }

    .row-top {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      margin-bottom: .35rem;
    }

    .row-status {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: .4rem;
      color: #333;
      font-weight: 600;
    }

    .name {
      font-size: 1.05rem;
      font-weight: 700;
      margin: 0;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      border: 0;
    }

    .st-red {
      background: var(--status-red);
    }

    .st-yellow {
      background: var(--status-yellow);
    }

    .st-green {
      background: var(--status-green);
    }

    .empty {
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 22px;
      text-align: center;
      color: #666;
      background: linear-gradient(180deg, #fff, #fafbff);
    }

    html {
      font-size: 16px;
    }

    @media(max-width:768px) {
      html {
        font-size: clamp(15px, 2.7vw, 18px);
      }
    }

    /* Base + mobile scale (safe, no transform) */
    html {
      font-size: 16px;
    }

    @media (max-width: 768px) {
      html {
        font-size: 14px;
      }

      /* ~150% of 16px */
    }

    * {
      font-family: 'IBM Plex Sans Thai', system-ui, sans-serif;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100svh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: clamp(0.875rem, 2.5vw, 1.125rem);
      /* 14px..18px desktop, scales on mobile via html font-size */
      line-height: 1.6;
      background: #fafafa;
      color: #111;
    }

    @media (min-width: 768px) {
      body {
        min-height: 100svh;
      }

      #dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        align-items: stretch;
        gap: 12px;
      }

      #suggest {
        display: none;
      }

      #todoCard {
        grid-column: 1 !important;
        grid-row: 1 / span 2 !important;
        align-self: stretch;
      }
    }

    /* Top bar */
    .topbar {
      background: linear-gradient(90deg, #AD28F5, #2D68F2);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2rem;
      font-weight: 600;
      position: relative;
      flex: 0 0 auto;
    }

    /* Dashboard grid */
    #dashboard {
      flex: 1 1 auto;
      display: none;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 2fr 1fr;
      gap: 10px;
      padding: 10px;
      background: #fafafa;
      min-height: 0;
      /* allow children to scroll */
    }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      min-height: 0;
      /* allow internal scrolling */
      display: flex;
      flex-direction: column;
    }

    /* Announcements */
    .announcement-card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.8rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .announcement-card.important {
      border-left: 6px solid #f82634;
      background: #ffeaea;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .announcement-title {
      font-weight: 700;
      font-size: 1rem;
      margin: 0 0 0.3rem 0;
    }

    .announcement-content {
      font-size: 0.9rem;
      color: #333;
      margin: 0;
    }

    /* Account dropdown */
    #accountDropdown {
      position: absolute;
      top: 60px;
      right: 20px;
      width: 260px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1rem;
      display: none;
      z-index: 1000;
      color: #000;
    }

    #accountDropdown p {
      margin: 0.4rem 0;
      font-size: 0.9rem;
      color: #000;
    }

    #accountDropdown span {
      color: #666;
    }

    #accountDropdown button {
      width: 100%;
      background: #AD28F5;
      color: white;
      border: none;
      padding: 0.6rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.6rem;
    }

    /* Login box */
    #loginBox {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      width: min(90%, 340px);
      max-height: 90svh;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      overflow-y: auto;
      font-size: 1rem;
    }

    /* Status circles */
    .status-circle {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }

    .status-red {
      border: 2px solid #f82634;
      background: rgba(248, 38, 52, 0.2);
    }

    .status-yellow {
      border: 2px solid #f5c32c;
      background: rgba(245, 195, 44, 0.2);
    }

    .status-green {
      border: 2px solid #2cbf3a;
      background: rgba(44, 191, 58, 0.2);
    }

    .task-item {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .task-strong {
      font-weight: 700;
    }

    /* To-Do header with arrow */
    #todoHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    #todoArrow {
      transition: transform 0.3s ease;
      display: inline-block;
    }

    #todoArrow.collapsed {
      transform: rotate(-90deg);
    }

    /* Lists scroll independently */
    #taskList {
      margin: 0;
      padding-left: 1.2rem;
      overflow-y: auto;
      max-height: 80vh;
      list-style: none;
      transition: max-height 0.3s ease;
    }

    #announcementsContainer {
      overflow-y: auto;
      max-height: 40vh;
    }

    /* Recruitment iframe fills content area */
    #recruitment {
      flex: 1 1 auto;
      display: none;
      min-height: 0;
    }

    #recruitment iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Responsive stacking */
    @media (max-width:1000px) {
      #appContent {
        overflow-y: auto;
      }

      #dashboard {
        flex: 1 1 auto;
        display: grid;
        /* 2 columns */
        grid-template-columns: 1fr 1fr;
        /* ‚úÖ First row = 2fr, Second = 1fr */
        grid-template-rows: 2fr 1fr;
        gap: 10px;
        padding: 10px;
        min-height: 0;
      }


      #dashboard>div {
        grid-row: auto !important;
      }
    }

    /* Extra mobile spacing/tap sizes */
    @media (max-width: 768px) {

      #loginBox,
      #accountDropdown {
        width: 90% !important;
      }

      button,
      input,
      textarea {
        font-size: 1rem;
        padding: 0.8rem;
      }
    }
  </style>
</head>

<body>

  <div id="appContent" style="flex:1;display:none;flex-direction:column;min-height:0;position:relative;">
    <!-- Top Bar -->
    <div class="topbar">
      <div>TStaff</div>
      <div id="helloName" style="cursor:pointer;">
        <span style="color:#ddd;font-weight:400;">Hello, </span>
        <span id="userName" style="font-weight:700;">Guest</span>
      </div>
      <div id="accountDropdown">
        <p><strong>Full Name:</strong> <span id="accountName"></span></p>
        <p><strong>Email:</strong> <span id="accountEmail"></span></p>
        <p><strong>Status:</strong> <span id="accountStatus" style="font-weight:600;"></span></p>
        <p style="font-size:12px; color:#666; font-weight:400;">TStaff Version 3.1</p>
        <a href="https://u.lin.ee/t3mThvd" id="trbutton"><button style="background-color:#2D68F2; text-decoration:none; color:#fff;">TRewards</button></a>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
      <!-- Mobile replacement shortcuts -->
      <div id="mobileShortcuts" style="display:none; flex-direction:column; gap:10px;">
        <a href="/tstaff/taskcheck" style="display:block; text-align:center; padding:1rem; background:#AD28F5; color:white;
            font-weight:700; border-radius:10px; text-decoration:none;">
          üìã Taskcheck
        </a>
        <a href="https://u.lin.ee/t3mThvd" style="display:block; text-align:center; padding:1rem; background:#2D68F2; color:white;
            font-weight:700; border-radius:10px; text-decoration:none;">
          üéÅ TRewards
        </a>
      </div>

      <!-- To-Do -->
      <div id="todoCard" class="card" style="grid-row:1; display:flex; flex-direction:column;">
        <div>
          <h2 style="margin-top:0;color:#AD28F5;">üìã Top 3 Tasks</h2>
          <ul id="topTasks" style="list-style:none;padding-left:0;margin-top:0.5rem;"></ul>
          <a href="https://tcfthailand.com/tstaff/taskcheck" target="_blank"
            style="display:inline-block;margin-top:0.6rem;color:#2D68F2;text-decoration:none;font-weight:600;">View in
            Taskcheck ‚Üí</a>
        </div>

      </div>
      <!-- Announcements -->
      <div class="card">
        <h2 style="margin-top:0;color:#AD28F5;">üì¢ Announcements</h2>
        <div id="announcementsContainer"></div>
      </div>
      <div id="usefulinfo" class="card">
        <div style="text-align:center;">
          <!--<h3 style="margin:0.3rem 0;font-weight:600;">üïí <span id="countdown">Loading...</span></h3>-->
          <h3 style="margin:0;font-weight:600;cursor:pointer;color:#2D68F2" onclick="showinfo()">üóìÔ∏è Meeting Information
          </h3>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:1rem 0;">

        <div style="text-align:center;">
          <h3 style="margin:0;font-weight:600;">üìù Message from the Board</h3>
          <p id="internalFocus" style="font-size:0.9rem;color:#333;">Loading...</p>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:1rem 0;margin-top: 0;">

        <div style="text-align:center;color:#777;font-style:italic;font-size:0.9rem;">
          <span id="quoteText">Loading inspiration...</span>
        </div>
      </div>
    </div>

    <!-- Recruitment -->
    <div id="recruitment">
      <iframe src="https://tcfthailand.com/tstaff/recruiter"></iframe>
    </div>
  </div>

  <!-- Login Overlay -->
  <div id="loginOverlay"
    style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;">
    <div id="loginBox">
      <div style="display:flex;margin-bottom:1rem;border-bottom:2px solid #eee;">
        <div id="loginTab" onclick="showTab('login')"
          style="flex:1;text-align:center;padding:0.6rem;cursor:pointer;font-weight:600;color:#AD28F5;border-bottom:3px solid #AD28F5;">
          Login</div>
        <div id="signupTab" onclick="showTab('signup')"
          style="flex:1;text-align:center;padding:0.6rem;cursor:pointer;font-weight:600;color:#555;border-bottom:3px solid transparent;">
          Apply</div>
      </div>
      <div id="loginForm">
        <input id="loginEmail" type="email" placeholder="Email"
          style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #ccc;border-radius:6px;">
        <input id="loginPassword" type="password" placeholder="Password"
          style="width:100%;padding:0.8rem;margin-bottom:1rem;border:1px solid #ccc;border-radius:6px;">
        <button onclick="login()"
          style="width:100%;background:#AD28F5;color:white;border:none;padding:0.8rem;border-radius:6px;font-weight:600;cursor:pointer;">Login</button>
        <p id="loginStatus" style="margin-top:0.8rem;font-size:0.9rem;color:#d23;"></p>
      </div>
      <div id="signupForm" style="display:none;">
        <input id="signupName" type="text" placeholder="Full Name"
          style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #ccc;border-radius:6px;">
        <input id="signupEmail" type="email" placeholder="Email"
          style="width:100%;padding:0.8rem;margin-bottom:0.8rem;border:1px solid #ccc;border-radius:6px;">
        <input id="signupPassword" type="password" placeholder="Password"
          style="width:100%;padding:0.8rem;margin-bottom:1rem;border:1px solid #ccc;border-radius:6px;">
        <button onclick="signup()"
          style="width:100%;background:#2D68F2;color:white;border:none;padding:0.8rem;border-radius:6px;font-weight:600;cursor:pointer;">Sign
          Up</button>
        <p id="signupStatus" style="margin-top:0.8rem;font-size:0.9rem;color:#d23;"></p>
      </div>
    </div>
  </div>

  <style>
    /* Overlay background */
    #infobox-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(3px);
    }

    /* Popup box */
    #infobox {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 8px 26px rgba(0, 0, 0, 0.25);
      padding: 22px 26px;
      width: min(90%, 360px);
      position: relative;
      animation: popupIn 0.25s ease;
      font-family: 'IBM Plex Sans Thai', sans-serif;
      color: #111;
      text-align: center;
    }

    /* Slide-fade animation */
    @keyframes popupIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Close button */
    #infobox .closebtn {
      position: absolute;
      top: 10px;
      right: 12px;
      font-weight: 700;
      cursor: pointer;
      color: #666;
      font-size: 1.1rem;
      user-select: none;
    }

    #infobox .closebtn:hover {
      color: #000;
    }
  </style>

  <!-- Popup HTML -->
  <div id="infobox-overlay" onclick="hideinfo()">
    <div id="infobox" onclick="event.stopPropagation()">
      <div class="closebtn" onclick="hideinfo()">‚úï</div>
      <h3 style="margin-top:0;color:#2D68F2;">Meeting Information</h3>
      <p>
        The next team meeting will be held on <b id="countdown">date</b>.
      </p>
      <p id="meetingnote"></p>
      <a href="https://tcfthailand.com/tstaff/calendar" style="color:#2D68F2; text-decoration:none; font-weight:bolder;"
        target="_blank">View Full Calendar ‚Üí</a>
    </div>
  </div>

  <script>
    function showinfo() {
      document.getElementById("infobox-overlay").style.display = "flex";
    }

    function hideinfo() {
      document.getElementById("infobox-overlay").style.display = "none";
    }
  </script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.96);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>

  <!--Mobile-->
  <style>
    /* Desktop: show planning card, hide shortcuts */
    #mobileShortcuts {
      display: none !important;
    }

    #todoCard,
    #usefulinfo {
      display: flex !important;
    }

    /* Mobile: hide planning card, show shortcuts */
    @media (max-width: 1000px) {
      #mobileShortcuts, #usefulInfo {
        display: flex !important;
      }

      #todoCard {
        display: none !important;
      }
    }

    /* Mobile Responsive Layout Fix */
    @media (max-width: 1000px) {
      #dashboard {
        display: flex !important;
        flex-direction: column;
        height: calc(100svh - 60px);
        /* full height minus topbar */
        gap: 10px;
        padding: 10px;
      }

      #mobileShortcuts {
        width: 100%;
        display: flex !important;
        flex-direction: column;
        gap: 10px;
        flex: 0 0 auto;
      }

      .card {
        width: 100%;
        flex: 0 0 auto;
      }

      /* Announcements takes the remaining vertical space before suggestions */
      .card:nth-of-type(1) {
        flex: 1 1 auto;
        height: 40%;
        overflow-y: auto;
      }

      /* Suggestions takes 2/3 of leftover space */
      .card:nth-of-type(2) {
        flex: 0 0 auto;
        overflow-y: auto;
      }
    }

    /* Tablet font & layout tuning for left column */
    @media (max-width: 1200px) and (min-width: 768px) {
      #usefulinfo {
        font-size: 0.9rem;
        line-height: 1;
      }

      #quoteText,
      #internalFocus {
        line-height: 1.2 !important;
      }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKHyMNxgnUH9zn0HQHDNf98GFphC9rv_4",
      authDomain: "tstaff-tcf.firebaseapp.com",
      projectId: "tstaff-tcf",
      storageBucket: "tstaff-tcf.firebasestorage.app",
      messagingSenderId: "1038965947691",
      appId: "1:1038965947691:web:8a2f21a6424b82c14ad96e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const appContent = document.getElementById("appContent");
    const userNameEl = document.getElementById("userName");
    const dashboard = document.getElementById("dashboard");
    const recruitment = document.getElementById("recruitment");
    const accountEmailEl = document.getElementById("accountEmail");
    const accountNameEl = document.getElementById("accountName");
    const accountStatusEl = document.getElementById("accountStatus");
    const accountDropdown = document.getElementById("accountDropdown");
    const helloName = document.getElementById("helloName");
    const announcementsContainer = document.getElementById("announcementsContainer");
    const suggestionInput = document.getElementById("suggestionInput");
    const suggestionStatus = document.getElementById("suggestionStatus");
    const trbutton = document.getElementById("trbutton");

    const taskList = document.getElementById("taskList");
    const taskStats = document.getElementById("taskStats");
    const todoArrow = document.getElementById("todoArrow");

    function abbreviate(full) {
      const parts = full.split(" ");
      return parts.length > 1 ? parts[0] + " " + parts[1][0] + "." : full;
    }

    // Account dropdown
    helloName?.addEventListener("click", (e) => {
      e.stopPropagation();
      accountDropdown.style.display = accountDropdown.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", (e) => {
      if (accountDropdown.style.display === "block" && !accountDropdown.contains(e.target) && !helloName.contains(e.target)) {
        accountDropdown.style.display = "none";
      }
    });

    // Tabs
    window.showTab = function (tab) {
      document.getElementById("loginForm").style.display = tab === "login" ? "block" : "none";
      document.getElementById("signupForm").style.display = tab === "signup" ? "block" : "none";
      document.getElementById("loginTab").style.color = tab === "login" ? "#AD28F5" : "#555";
      document.getElementById("signupTab").style.color = tab === "signup" ? "#2D68F2" : "#555";
      document.getElementById("loginTab").style.borderBottom = tab === "login" ? "3px solid #AD28F5" : "3px solid transparent";
      document.getElementById("signupTab").style.borderBottom = tab === "signup" ? "3px solid #2D68F2" : "3px solid transparent";
    };

    // Load Announcements
    function loadAnnouncements() {
      const q = query(collection(db, "announce"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        announcementsContainer.innerHTML = "";
        const important = [], normal = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.important) important.push({ id: docSnap.id, ...data });
          else normal.push({ id: docSnap.id, ...data });
        });
        [...important, ...normal].forEach(item => {
          const date = item.timestamp?.toDate().toISOString().split("T")[0] || "Unknown Date";
          const card = document.createElement("div");
          card.className = "announcement-card" + (item.important ? " important" : "");
          card.innerHTML = `<div class="announcement-title">[${date}] ${item.title}</div><p class="announcement-content">${item.content}</p>`;
          announcementsContainer.appendChild(card);
        });
      });
    }

    // Load Tasks with counts + done at bottom
    function loadTasks() {
      const q = query(collection(db, "tasks"), orderBy("priority", "asc"));
      onSnapshot(q, (snapshot) => {
        taskList.innerHTML = "";
        const notDone = [], done = [];
        let redCount = 0, yellowCount = 0, greenCount = 0;

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.status === "green") done.push(data);
          else notDone.push(data);

          if (data.status === "red") redCount++;
          if (data.status === "yellow") yellowCount++;
          if (data.status === "green") greenCount++;
        });

        taskStats.innerHTML = `
          <span style="color:#f82634;">‚óè ${redCount}</span>
          <span style="margin:0 6px;color:#f5c32c;">‚óè ${yellowCount}</span>
          <span style="color:#2cbf3a;">‚óè ${greenCount}</span>
        `;

        const ordered = [...notDone, ...done];
        ordered.forEach(task => {
          const li = document.createElement("li");
          li.className = "task-item" + (task.strong ? " task-strong" : "");
          li.innerHTML = `<span class="status-circle status-${task.status}"></span>${task.name}`;
          taskList.appendChild(li);
        });
      });
    }

    // Due label mapping
    const DUE_LABELS = {
      10: "October",
      111: "Early November",
      112: "Late November",
      121: "Early December",
      122: "Late December",
      1: "January"
    };

    // Custom due order
    function dueRank(d) {
      if (d === 10) return 1;
      if (d === 111) return 2;
      if (d === 112) return 3;
      if (d === 121) return 4;
      if (d === 122) return 5;
      if (d === 1) return 6;
      return 999;
    }

    // Loads Top Tasks formatted like Taskcheck
    async function loadTopTasks() {
      const DEPT_LABELS = {
        allmembers: "All Members",
        core: "Core Team",
        finance: "Finances & Sponsors",
        pr: "Public Relations",
        supervision: "Student Supervision",
        activities: "Activities",
        recruits: "New Recruits",
        cc: "Creative Contest"
      };

      function deptClass(dep) {
        return {
          allmembers: "dept-all",
          core: "dept-core",
          finance: "dept-finance",
          pr: "dept-pr",
          supervision: "dept-supervision",
          activities: "dept-activities",
          recruits: "dept-recruits",
          cc: "dept-cc"
        }[dep] || "dept-all";
      }

      const q = query(collection(db, "taskcheck"));

      onSnapshot(q, (snap) => {
        const activeTasks = [];

        snap.forEach((docSnap) => {
          const t = docSnap.data();
          const status = (t.status || "").toLowerCase();

          // Skip done tasks
          if (status === "green") return;

          activeTasks.push({
            id: docSnap.id,
            name: (t.name || "Untitled Task").trim(),
            priority: Number(t.priority) || 99,
            status,
            department: (t.department || "allmembers").toLowerCase(),
            due: Number(t.due) || 999,
            important: !!t.important
          });
        });

        // Sort:
        // 1) Important first
        // 2) Due (via dueRank)
        // 3) Priority (1 < 2 < 3)
        // 4) Department: allmembers first, then A‚ÜíZ
        // 5) Status: red before yellow
        // 6) Name A‚ÜíZ
        activeTasks.sort((a, b) => {
          // 1. Important
          const impA = a.important ? 1 : 0;
          const impB = b.important ? 1 : 0;
          if (impA !== impB) return impB - impA; // important (1) before 0

          // 2. Due
          const dA = dueRank(a.due), dB = dueRank(b.due);
          if (dA !== dB) return dA - dB;

          // 3. Priority
          if (a.priority !== b.priority) return a.priority - b.priority;

          // 4. Department (allmembers first)
          const depA = a.department;
          const depB = b.department;
          if (depA === "allmembers" && depB !== "allmembers") return -1;
          if (depB === "allmembers" && depA !== "allmembers") return 1;
          if (depA !== depB) return depA.localeCompare(depB);

          // 5. Status: red (1) then yellow (2)
          const statusRank = { red: 1, yellow: 2 };
          const sA = statusRank[a.status] || 99;
          const sB = statusRank[b.status] || 99;
          if (sA !== sB) return sA - sB;

          // 6. Name
          return a.name.localeCompare(b.name, "th");
        });

        const final = activeTasks.slice(0, 3);
        const list = document.getElementById("topTasks");
        list.innerHTML = "";

        if (!final.length) {
          list.innerHTML = "<li style='color:#777;'>No active tasks üéâ</li>";
          return;
        }

        final.forEach((task, idx) => {
          const dueText = DUE_LABELS[task.due] || task.due;
          const prioLabel = { 1: "High", 2: "Medium", 3: "Low" }[task.priority] || `P${task.priority}`;
          const statusLabel =
            task.status === "red" ? "Not Done" :
              task.status === "yellow" ? "In Progress" :
                task.status;

          const dotClass =
            task.status === "red" ? "st-red" :
              task.status === "yellow" ? "st-yellow" :
                "st-green";

          const deptLabel = DEPT_LABELS[task.department] || task.department;
          const deptClassName = deptClass(task.department);
          const prioClass = `prio-${task.priority}`;

          const li = document.createElement("li");
          li.style.listStyle = "none";
          li.style.marginBottom = "10px";

          li.innerHTML = `
        <div class="card"
             style="border-left-width:4px;
                    border-left-color:${task.important ? "#ef4444" : "transparent"};
                    cursor:default; padding:10px 12px;">
          <div class="row-top">
            <span class="pill ${prioClass}">${prioLabel}</span>
            <span class="pill ${deptClassName}">${deptLabel}</span>
            <span class="pill">${dueText}</span>
          </div>
          <div class="row-status">
            <span class="status-dot ${dotClass}"></span>
            <span>${statusLabel}</span>
          </div>
          <p class="name" style="margin-top:2px;">${task.name}</p>
        </div>
      `;

          list.appendChild(li);
        });
      });
    }


    // Countdown
    function updateCountdown() {
      const eventDate = new Date("2026-01-11");
      const today = new Date();
      const diff = Math.floor((eventDate - today) / (1000 * 60 * 60 * 24));
      document.getElementById("countdown").textContent = `${diff} days until TCF 2026`;
    }

    // Load Internal Focus (dashboard ‚Üí note ‚Üí text)
    async function loadInternalFocus() {
      const ref = doc(db, "dashboard", "note");
      const ref2 = doc(db, "dashboard", "meetingnote");
      const snap = await getDoc(ref);
      const snap2 = await getDoc(ref2);
      if (snap.exists()) {
        document.getElementById("internalFocus").innerHTML = snap.data().text || "No current focus.";
      } else {
        document.getElementById("internalFocus").innerHTML = "No current focus.";
      }
      if (snap2.exists()) {
        document.getElementById("meetingnote").innerHTML = snap2.data().text || "";
      } else {
        document.getElementById("meetingnote").innerHTML = "";
      }
    }

    // Random quote
    function loadQuote() {
      const quotes = [
        "Discipline is the bridge between goals and accomplishment.",
        "Small steps every day lead to big results.",
        "Teamwork divides the task and multiplies the success.",
        "Do what you can, with what you have, where you are.",
        "Focus on progress, not perfection.",
        "The only way to achieve the impossible is to believe it is possible.",
        "Great things are done by a series of small things brought together.",
        "Success is the sum of small efforts, repeated day in and day out.",
        "Believe you can and you're halfway there.",
        "Look, and you will not see.",
        "Have you eaten your musket?",
        "Thank you for being a part of our team! ‚ù§Ô∏è",
      ];
      const random = quotes[Math.floor(Math.random() * quotes.length)];
      document.getElementById("quoteText").textContent = random;
    }


    // Suggestions
    window.submitSuggestion = async function () {
      const content = suggestionInput.value.trim();
      if (!content) { suggestionStatus.textContent = "Please write something before submitting."; return; }
      try {
        await addDoc(collection(db, "suggestions"), { content: content, timestamp: serverTimestamp() });
        suggestionStatus.style.color = "green";
        suggestionStatus.textContent = "Suggestion submitted!";
        suggestionInput.value = "";
      }
      catch (err) {
        suggestionStatus.style.color = "red";
        suggestionStatus.textContent = "Error: " + err.message;
      }
    };

    // Auth handling (restored)
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById("loginOverlay").style.display = "none";
        appContent.style.display = "flex";

        const ref = doc(db, "users", user.email);
        let snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          userNameEl.textContent = abbreviate(data.name);
          accountNameEl.textContent = data.name;
          accountEmailEl.textContent = user.email;
          accountStatusEl.textContent = data.member ? "Member" : "Recruit";

          if (data.member) {
            dashboard.style.display = "grid";
            recruitment.style.display = "none";
            trbutton.style.display = "flex";
            loadAnnouncements();
            loadTasks();
            loadTopTasks();
            loadInternalFocus();
            loadQuote();
            loadNextMeeting();

          } else {
            dashboard.style.display = "none";
            recruitment.style.display = "flex";
            trbutton.style.display = "none";
          }
        } else {
          await setDoc(ref, { name: user.email, member: false });
          userNameEl.textContent = user.email;
          accountNameEl.textContent = user.email;
          accountEmailEl.textContent = user.email;
          accountStatusEl.textContent = "Recruit";
          dashboard.style.display = "none";
          recruitment.style.display = "flex";
        }
      } else {
        appContent.style.display = "none";
        document.getElementById("loginOverlay").style.display = "flex";
      }
    });

    // Login
    window.login = async function () {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (err) { document.getElementById("loginStatus").textContent = "Login failed: " + err.message; }
    };

    // Signup
    window.signup = async function () {
      const name = document.getElementById("signupName").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", email), { name: name, member: false });
      } catch (err) {
        document.getElementById("signupStatus").textContent = "Signup failed: " + err.message;
      }
    };

    // Logout
    window.logout = async function () {
      await signOut(auth);
      accountDropdown.style.display = "none";
      document.getElementById("loginOverlay").style.display = "flex";
    };

    // To-Do collapsible (mobile only)
    let todoCollapsed = true;

    // Collapse To-Do by default
    document.addEventListener("DOMContentLoaded", () => {
      const list = document.getElementById("taskList");
      const arrow = document.getElementById("todoArrow");
      if (window.innerWidth <= 768) {
        list.style.maxHeight = "0";
        arrow.classList.add("collapsed");
      }
    });

    window.toggleTodoMobile = function () {
      if (window.innerWidth > 768) return; // mobile only
      todoCollapsed = !todoCollapsed;
      const list = document.getElementById("taskList");
      list.style.maxHeight = todoCollapsed ? "0" : "80vh";
      todoArrow.classList.toggle("collapsed", todoCollapsed);
    };

    // Default tab
    showTab("login");

    window.loadNextMeeting = async function () {
      try {
        const res = await fetch('calendar.html');
        const text = await res.text();
        const match = text.match(/const\s+events\s*=\s*(\[[\s\S]*?\]);/);
        if (!match) throw new Error("No events found in calendar.html");

        const events = eval(match[1]);
        const now = new Date();
        const meetings = events
          .filter(e => e.title.toLowerCase().includes("meeting"))
          .map(e => ({ ...e, dateObj: new Date(e.date) }))
          .filter(e => e.dateObj >= now)
          .sort((a, b) => a.dateObj - b.dateObj);

        const next = meetings[0];
        const el = document.getElementById("countdown");

        if (next) {
          const d = next.dateObj;
          const formatted = `${d.getDate()} ${d.toLocaleString('en-US', { month: 'long' })} ${d.getFullYear()}`;
          el.textContent = formatted;
        } else {
          el.textContent = "No upcoming meetings.";
        }
      } catch (err) {
        console.error(err);
        const el = document.getElementById("countdown");
        if (el) el.textContent = "Unable to fetch meeting data.";
      }
    };


  </script>
</body>

</html>